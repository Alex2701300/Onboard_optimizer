<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CarLogix Full Debug Interface</title>

  <!-- Подключаем React, ReactDOM, Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: sans-serif;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 16px;
    }
    .tabs button {
      margin-right: 8px;
      padding: 8px 16px;
    }
    .card {
      background: #fff;
      padding: 16px;
      margin-top: 16px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    .success {
      background: #e7ffe7;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      color: #1a7a1a;
    }
    .error {
      background: #ffeaea;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      color: #9d1a1a;
    }
    label {
      display: block;
      font-weight: bold;
      margin: 4px 0;
    }
    input, select, textarea {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
    }
    button {
      cursor: pointer;
    }
    .sub-block {
      border: 1px solid #ccc;
      padding: 8px;
      margin: 8px 0;
      border-radius: 4px;
      background: #fafafa;
    }
    .sub-title {
      font-weight: bold;
      margin-bottom: 4px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .inline-btns button {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">

    // ------------------------------ UTILS ------------------------------
    async function checkDB() {
      try {
        const res = await fetch("/api/vehicles");
        if (!res.ok) throw new Error("Status=" + res.status);
        return "MongoDB connected ✔";
      } catch (err) {
        return "DB error: " + err.message;
      }
    }

    async function fetchAllVehicles() {
      const res = await fetch("/api/vehicles");
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Fetch error");
      }
      return await res.json();
    }

    async function fetchOneVehicle(id) {
      const res = await fetch("/api/vehicles/" + id);
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Fetch error");
      }
      return await res.json();
    }

    async function createVehicle(payload) {
      const res = await fetch("/api/vehicles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Creation error");
      }
      return await res.json();
    }

    async function updateVehicle(id, updates) {
      const res = await fetch("/api/vehicles/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates)
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Update error");
      }
      return await res.json();
    }

    async function deleteVehicle(id) {
      const res = await fetch("/api/vehicles/" + id, {
        method: "DELETE"
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Delete error");
      }
      return true;
    }

    // ------------------------------ CAR TAB ------------------------------
    function CarTab() {
      const [msg, setMsg] = React.useState("");
      const [form, setForm] = React.useState({
        vin: "",
        make: "",
        car_model: "",
        year: "2023",
        length_in: "200",
        width_in: "80",
        height_ft: "5",
        wheelbase_in: "110"
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        setMsg("");
        const payload = {
          type: "car",
          vin: form.vin,
          make: form.make,
          car_model: form.car_model,
          year: parseInt(form.year, 10),
          length_in: parseFloat(form.length_in),
          width_in: parseFloat(form.width_in),
          height_ft: parseFloat(form.height_ft),
          wheelbase_in: parseFloat(form.wheelbase_in)
        };
        try {
          const data = await createVehicle(payload);
          setMsg("Car created! ID=" + data.id);
          // Reset
          setForm({
            vin: "",
            make: "",
            car_model: "",
            year: "2023",
            length_in: "200",
            width_in: "80",
            height_ft: "5",
            wheelbase_in: "110"
          });
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      return (
        <div className="card">
          <h2>Create Car (all dims in inches/feet)</h2>
          {msg && <div>{msg}</div>}
          <form onSubmit={handleSubmit}>
            <label>VIN</label>
            <input
              value={form.vin}
              onChange={(e) => setForm({ ...form, vin: e.target.value })}
              required
            />
            <label>Make</label>
            <input
              value={form.make}
              onChange={(e) => setForm({ ...form, make: e.target.value })}
              required
            />
            <label>Model</label>
            <input
              value={form.car_model}
              onChange={(e) => setForm({ ...form, car_model: e.target.value })}
              required
            />
            <label>Year</label>
            <input
              type="number"
              value={form.year}
              onChange={(e) => setForm({ ...form, year: e.target.value })}
              required
            />
            <label>Length (inches)</label>
            <input
              type="number"
              value={form.length_in}
              onChange={(e) => setForm({ ...form, length_in: e.target.value })}
            />
            <label>Width (inches)</label>
            <input
              type="number"
              value={form.width_in}
              onChange={(e) => setForm({ ...form, width_in: e.target.value })}
            />
            <label>Height (feet)</label>
            <input
              type="number"
              value={form.height_ft}
              onChange={(e) => setForm({ ...form, height_ft: e.target.value })}
            />
            <label>Wheelbase (inches)</label>
            <input
              type="number"
              value={form.wheelbase_in}
              onChange={(e) =>
                setForm({ ...form, wheelbase_in: e.target.value })
              }
            />
            <button type="submit">Create Car</button>
          </form>
        </div>
      );
    }

    // ------------------------------ TRAILER TAB ------------------------------
    function TrailerTab() {
      const [msg, setMsg] = React.useState("");
      const [form, setForm] = React.useState({
        trailer_nickname: "",
        trailer_year: "2023",
        capacity_in: "500"
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        setMsg("");
        const payload = {
          type: "trailer",
          trailer_nickname: form.trailer_nickname,
          trailer_year: parseInt(form.trailer_year, 10),
          capacity_in: parseFloat(form.capacity_in)
        };
        try {
          const data = await createVehicle(payload);
          setMsg("Trailer created! ID=" + data.id);
          setForm({
            trailer_nickname: "",
            trailer_year: "2023",
            capacity_in: "500"
          });
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      return (
        <div className="card">
          <h2>Create Trailer</h2>
          {msg && <div>{msg}</div>}
          <form onSubmit={handleSubmit}>
            <label>Nickname</label>
            <input
              value={form.trailer_nickname}
              onChange={(e) =>
                setForm({ ...form, trailer_nickname: e.target.value })
              }
              required
            />
            <label>Year</label>
            <input
              type="number"
              value={form.trailer_year}
              onChange={(e) =>
                setForm({ ...form, trailer_year: e.target.value })
              }
              required
            />
            <label>Capacity (inches?)</label>
            <input
              type="number"
              value={form.capacity_in}
              onChange={(e) =>
                setForm({ ...form, capacity_in: e.target.value })
              }
            />
            <button type="submit">Create Trailer</button>
          </form>
        </div>
      );
    }

    // ------------------------- TRUCK SUB-FORMS (Edges, Slides, Joints, etc.) -------------------------

    function SlideEditor({ slide, onChange }) {
      const handle = (field, val) => {
        onChange({ ...slide, [field]: val });
      };
      return (
        <div className="sub-block">
          <div className="sub-title">Slide</div>
          <label>Type</label>
          <select
            value={slide.type || "none"}
            onChange={(e) => handle("type", e.target.value)}
          >
            <option value="none">None</option>
            <option value="platform_slide">Platform Slide</option>
            <option value="a_slide">A Slide</option>
            <option value="b_slide">B Slide</option>
          </select>

          <label>Min Length (inches)</label>
          <input
            type="number"
            value={slide.min_length || ""}
            onChange={(e) => handle("min_length", parseFloat(e.target.value) || 0)}
          />

          <label>Max Length (inches)</label>
          <input
            type="number"
            value={slide.max_length || ""}
            onChange={(e) => handle("max_length", parseFloat(e.target.value) || 0)}
          />

          <label>Min Distance (inches)</label>
          <input
            type="number"
            value={slide.min_distance || ""}
            onChange={(e) => handle("min_distance", parseFloat(e.target.value) || 0)}
          />

          <label>Max Distance (inches)</label>
          <input
            type="number"
            value={slide.max_distance || ""}
            onChange={(e) => handle("max_distance", parseFloat(e.target.value) || 0)}
          />
        </div>
      );
    }

    function EdgeEditor({ edge, onChangeEdge }) {
      const handle = (field, val) => {
        onChangeEdge({ ...edge, [field]: val });
      };

      return (
        <div className="sub-block" style={{ background: "#fafce7" }}>
          <div className="sub-title">Edge {edge.position || "?"}</div>
          <label>Edge Position (A/B)</label>
          <input
            value={edge.position || ""}
            onChange={(e) => handle("position", e.target.value)}
          />

          <label>Edge Type</label>
          <select
            value={edge.type || "static"}
            onChange={(e) => handle("type", e.target.value)}
          >
            <option value="mobile">mobile</option>
            <option value="static">static</option>
          </select>

          {/* For static edges, we store `height`. For mobile edges, `min_height` / `max_height`. */}
          <label>Height (if static, in inches)</label>
          <input
            type="number"
            value={edge.height || ""}
            onChange={(e) => handle("height", parseFloat(e.target.value) || 0)}
          />

          <label>Min Height (if mobile)</label>
          <input
            type="number"
            value={edge.min_height || ""}
            onChange={(e) => handle("min_height", parseFloat(e.target.value) || 0)}
          />

          <label>Max Height (if mobile)</label>
          <input
            type="number"
            value={edge.max_height || ""}
            onChange={(e) => handle("max_height", parseFloat(e.target.value) || 0)}
          />

          <label>Open Edge?</label>
          <input
            type="checkbox"
            checked={edge.is_open || false}
            onChange={(e) => handle("is_open", e.target.checked)}
          />

          <label>Load Overhang (inches)</label>
          <input
            type="number"
            value={edge.load_overhang || ""}
            onChange={(e) => handle("load_overhang", parseFloat(e.target.value) || 0)}
          />

          <label>Deeping (max 4)</label>
          <input
            type="number"
            value={edge.deeping || ""}
            onChange={(e) => handle("deeping", parseFloat(e.target.value) || 0)}
          />
        </div>
      );
    }

    function PlatformEditor({ platform, onChangePlatform, onRemovePlatform }) {
      const handle = (field, val) => {
        onChangePlatform({ ...platform, [field]: val });
      };

      const handleEdgeA = (updated) => {
        onChangePlatform({ ...platform, edge_a: updated });
      };
      const handleEdgeB = (updated) => {
        onChangePlatform({ ...platform, edge_b: updated });
      };
      const handleSlide = (updated) => {
        onChangePlatform({ ...platform, slide: updated });
      };

      return (
        <div className="sub-block" style={{ background: "#f0faff" }}>
          <div className="sub-title">
            Platform {platform.id || ""}{" "}
            <button type="button" onClick={onRemovePlatform}>Remove Platform</button>
          </div>
          <label>Platform ID</label>
          <input
            value={platform.id || ""}
            onChange={(e) => handle("id", e.target.value)}
          />

          <label>Deck Type</label>
          <select
            value={platform.deck_type || "upper_deck"}
            onChange={(e) => handle("deck_type", e.target.value)}
          >
            <option value="upper_deck">upper_deck</option>
            <option value="lower_deck">lower_deck</option>
          </select>

          <label>Position (int)</label>
          <input
            type="number"
            value={platform.position || ""}
            onChange={(e) => handle("position", parseInt(e.target.value) || 0)}
          />

          <label>Default Length (inches)</label>
          <input
            type="number"
            value={platform.default_length || ""}
            onChange={(e) =>
              handle("default_length", parseFloat(e.target.value) || 0)
            }
          />

          <EdgeEditor edge={platform.edge_a} onChangeEdge={handleEdgeA} />
          <EdgeEditor edge={platform.edge_b} onChangeEdge={handleEdgeB} />

          <label>Slide (optional)</label>
          {platform.slide ? (
            <SlideEditor slide={platform.slide} onChange={handleSlide} />
          ) : (
            <button
              type="button"
              onClick={() =>
                handle("slide", {
                  type: "none",
                  min_length: 0,
                  max_length: 0,
                  min_distance: 0,
                  max_distance: 0
                })
              }
            >
              + Add Slide
            </button>
          )}
        </div>
      );
    }

    function JointEditor({ joint, onChangeJoint, onRemoveJoint }) {
      const handle = (field, val) => {
        onChangeJoint({ ...joint, [field]: val });
      };
      return (
        <div className="sub-block" style={{ background: "#fdf0f0" }}>
          <div className="sub-title">
            Joint: {joint.type || ""}{" "}
            <button type="button" onClick={onRemoveJoint}>Remove Joint</button>
          </div>
          <label>Type</label>
          <select
            value={joint.type || "static_joint"}
            onChange={(e) => handle("type", e.target.value)}
          >
            <option value="static_joint">static_joint</option>
            <option value="open_free_joint">open_free_joint</option>
            <option value="articulated_sliding_joint">articulated_sliding_joint</option>
            <option value="semi_open_free_joint">semi_open_free_joint</option>
            <option value="semi_fix_joint">semi_fix_joint</option>
            <option value="turning_joint">turning_joint</option>
          </select>

          <label>Platform A</label>
          <input
            value={joint.platform_a || ""}
            onChange={(e) => handle("platform_a", e.target.value)}
          />

          <label>Platform B</label>
          <input
            value={joint.platform_b || ""}
            onChange={(e) => handle("platform_b", e.target.value)}
          />

          <label>Edge A (A/B?)</label>
          <input
            value={joint.edge_a || ""}
            onChange={(e) => handle("edge_a", e.target.value)}
          />

          <label>Edge B (A/B?)</label>
          <input
            value={joint.edge_b || ""}
            onChange={(e) => handle("edge_b", e.target.value)}
          />

          <label>Minimum Loading Distance (inches)</label>
          <input
            type="number"
            value={joint.minimum_loading_distance || ""}
            onChange={(e) =>
              handle("minimum_loading_distance", parseFloat(e.target.value) || 0)
            }
          />

          <label>Max Overlap (inches)</label>
          <input
            type="number"
            value={joint.max_overlap || ""}
            onChange={(e) =>
              handle("max_overlap", parseFloat(e.target.value) || 0)
            }
          />

          <label>Static Height (inches)</label>
          <input
            type="number"
            value={joint.static_height || ""}
            onChange={(e) =>
              handle("static_height", parseFloat(e.target.value) || 0)
            }
          />
        </div>
      );
    }

    function DeckEditor({ deck, onChangeDeck, onRemoveDeck }) {
      const handle = (field, val) => {
        onChangeDeck({ ...deck, [field]: val });
      };

      const addPlatform = () => {
        const newPlatform = {
          id: "PLAT-" + (deck.platforms.length + 1),
          deck_type: deck.type || "upper_deck",
          position: deck.platforms.length + 1,
          default_length: 240,
          edge_a: {
            position: "A",
            type: "static",
            height: 50,
            min_height: null,
            max_height: null,
            is_open: false,
            load_overhang: 0,
            deeping: 0
          },
          edge_b: {
            position: "B",
            type: "static",
            height: 50,
            min_height: null,
            max_height: null,
            is_open: false,
            load_overhang: 0,
            deeping: 0
          },
          slide: null
        };
        onChangeDeck({
          ...deck,
          platforms: [...deck.platforms, newPlatform]
        });
      };

      const removePlatform = (idx) => {
        const newPlats = [...deck.platforms];
        newPlats.splice(idx, 1);
        onChangeDeck({ ...deck, platforms: newPlats });
      };

      const handlePlatformChange = (idx, updated) => {
        const newPlats = [...deck.platforms];
        newPlats[idx] = updated;
        onChangeDeck({ ...deck, platforms: newPlats });
      };

      const addJoint = () => {
        const newJoint = {
          type: "static_joint",
          platform_a: "",
          platform_b: "",
          edge_a: "",
          edge_b: ""
        };
        onChangeDeck({
          ...deck,
          joints: [...deck.joints, newJoint]
        });
      };

      const removeJoint = (idx) => {
        const newJs = [...deck.joints];
        newJs.splice(idx, 1);
        onChangeDeck({ ...deck, joints: newJs });
      };

      const handleJointChange = (idx, updated) => {
        const newJs = [...deck.joints];
        newJs[idx] = updated;
        onChangeDeck({ ...deck, joints: newJs });
      };

      return (
        <div className="sub-block" style={{ background: "#fffdf0" }}>
          <div className="sub-title">
            Deck: {deck.type || "??"}{" "}
            <button type="button" onClick={onRemoveDeck}>Remove Deck</button>
          </div>
          <label>Deck Type</label>
          <select
            value={deck.type || "upper_deck"}
            onChange={(e) => handle("type", e.target.value)}
          >
            <option value="upper_deck">upper_deck</option>
            <option value="lower_deck">lower_deck</option>
          </select>

          <label>Total Length (inches)</label>
          <input
            type="number"
            value={deck.total_length || ""}
            onChange={(e) => handle("total_length", parseFloat(e.target.value) || 0)}
          />

          <div style={{ marginTop: "6px" }}>
            <strong>Platforms:</strong>
            <button type="button" onClick={addPlatform} style={{ marginLeft: "8px" }}>
              + Add Platform
            </button>
          </div>
          {deck.platforms.map((plat, i) => (
            <PlatformEditor
              key={i}
              platform={plat}
              onChangePlatform={(upd) => handlePlatformChange(i, upd)}
              onRemovePlatform={() => removePlatform(i)}
            />
          ))}

          <div style={{ marginTop: "6px" }}>
            <strong>Joints:</strong>
            <button type="button" onClick={addJoint} style={{ marginLeft: "8px" }}>
              + Add Joint
            </button>
          </div>
          {deck.joints.map((jt, i) => (
            <JointEditor
              key={i}
              joint={jt}
              onChangeJoint={(upd) => handleJointChange(i, upd)}
              onRemoveJoint={() => removeJoint(i)}
            />
          ))}
        </div>
      );
    }

    function VerticalConnectionEditor({ conn, onChangeConnection, onRemove }) {
      const handle = (field, val) => {
        onChangeConnection({ ...conn, [field]: val });
      };
      const handleClearanceProfile = (text) => {
        // user might enter "front=72,middle=70,rear=72"
        // parse into object
        const obj = {};
        text.split(",").forEach((pair) => {
          const [k,v] = pair.split("=").map(s => s.trim());
          if (k) {
            obj[k] = parseFloat(v) || 0;
          }
        });
        handle("clearance_profile", obj);
      };
      return (
        <div className="sub-block" style={{ background: "#ffeef0" }}>
          <div className="sub-title">
            VerticalConnection
            <button type="button" onClick={onRemove} style={{ marginLeft: "8px" }}>
              Remove
            </button>
          </div>
          <label>Upper Platform ID</label>
          <input
            value={conn.upper_platform_id || ""}
            onChange={(e) => handle("upper_platform_id", e.target.value)}
          />

          <label>Lower Platform ID</label>
          <input
            value={conn.lower_platform_id || ""}
            onChange={(e) => handle("lower_platform_id", e.target.value)}
          />

          <label>Clearance Profile (like "front=72,middle=68,rear=72")</label>
          <textarea
            rows={2}
            value={
              conn.clearance_profile
                ? Object.entries(conn.clearance_profile)
                    .map(([k,v]) => `${k}=${v}`)
                    .join(",")
                : ""
            }
            onChange={(e) => handleClearanceProfile(e.target.value)}
          />

          <label>Min Clearance (inches)</label>
          <input
            type="number"
            value={conn.min_clearance || ""}
            onChange={(e) => handle("min_clearance", parseFloat(e.target.value) || 0)}
          />
        </div>
      );
    }

    // ------------------------------ BIG TRUCK FORM (CREATE/EDIT) ------------------------------
    function TruckForm() {
      // базовая часть
      const [msg, setMsg] = React.useState("");
      const [editingId, setEditingId] = React.useState(null); // if editing existing truck
      const [form, setForm] = React.useState({
        nickname: "",
        model: "",
        year: "2023",
        truck_type: "semi",
        coupling_type: "none",
        gvwr: "40000",
        loading_spots: "0",
        deck_count: "1",
        upper_deck: null,
        lower_deck: null,
        vertical_connections: []
      });
      const [decks, setDecks] = React.useState([]); // array of Deck
      // each deck = {type:"upper_deck", total_length:0, platforms:[], joints:[]}

      const handleChange = (field, val) => {
        setForm({ ...form, [field]: val });
      };

      const addDeck = () => {
        const newDeck = {
          type: "upper_deck",
          total_length: 0,
          platforms: [],
          joints: []
        };
        setDecks([...decks, newDeck]);
      };

      const removeDeck = (idx) => {
        const newDs = [...decks];
        newDs.splice(idx, 1);
        setDecks(newDs);
      };

      const handleDeckChange = (idx, updated) => {
        const newDs = [...decks];
        newDs[idx] = updated;
        setDecks(newDs);
      };

      const [verticalConns, setVerticalConns] = React.useState([]);

      const addVerticalConn = () => {
        const newVC = {
          upper_platform_id: "",
          lower_platform_id: "",
          clearance_profile: {},
          min_clearance: 0
        };
        setVerticalConns([...verticalConns, newVC]);
      };

      const removeVerticalConn = (idx) => {
        const newVC = [...verticalConns];
        newVC.splice(idx, 1);
        setVerticalConns(newVC);
      };

      const handleVCChange = (idx, updated) => {
        const newVC = [...verticalConns];
        newVC[idx] = updated;
        setVerticalConns(newVC);
      };

      // Submit
      const handleSubmit = async (e) => {
        e.preventDefault();
        setMsg("");
        // собираем payload
        const finalPayload = {
          type: "truck",
          nickname: form.nickname,
          truck_year: parseInt(form.year, 10),
          truck_model: form.model,
          truck_type: form.truck_type,
          coupling_type: form.coupling_type,
          gvwr_lbs: parseFloat(form.gvwr),
          loading_spots: parseInt(form.loading_spots, 10),
          deck_count: parseInt(form.deck_count, 10)
        };
        // переводим decks[0] => upper_deck, decks[1] => lower_deck ...
        if (decks[0]) {
          finalPayload.upper_deck = decks[0];
        }
        if (decks[1]) {
          finalPayload.lower_deck = decks[1];
        }
        if (verticalConns.length > 0) {
          finalPayload.vertical_connections = verticalConns;
        }

        try {
          let data;
          if (!editingId) {
            data = await createVehicle(finalPayload);
          } else {
            // update existing
            data = await updateVehicle(editingId, finalPayload);
          }
          setMsg((editingId ? "Updated" : "Created") + " Truck ID=" + data.id);
          // reset
          setEditingId(null);
          setForm({
            nickname: "",
            model: "",
            year: "2023",
            truck_type: "semi",
            coupling_type: "none",
            gvwr: "40000",
            loading_spots: "0",
            deck_count: "1"
          });
          setDecks([]);
          setVerticalConns([]);
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      // expose a function to load existing truck
      const loadTruck = (truckDoc) => {
        setEditingId(truckDoc.id);
        const d = truckDoc.data;
        setForm({
          nickname: d.nickname,
          model: d.truck_model,
          year: d.truck_year+"",
          truck_type: d.truck_type,
          coupling_type: d.coupling_type,
          gvwr: d.gvwr_lbs+"",
          loading_spots: d.loading_spots+"",
          deck_count: d.deck_count+""
        });
        // parse decks from d.upper_deck, d.lower_deck
        const ds = [];
        if (d.upper_deck) ds.push(d.upper_deck);
        if (d.lower_deck) ds.push(d.lower_deck);
        setDecks(ds);
        setVerticalConns(d.vertical_connections || []);
      };

      // Render
      return (
        <div className="card">
          <h2>{editingId ? "Edit Truck" : "Create Truck"}</h2>
          {msg && <div>{msg}</div>}
          <form onSubmit={handleSubmit}>
            <label>Nickname</label>
            <input
              value={form.nickname}
              onChange={(e) => handleChange("nickname", e.target.value)}
              required
            />
            <label>Model</label>
            <input
              value={form.model}
              onChange={(e) => handleChange("model", e.target.value)}
              required
            />
            <label>Year</label>
            <input
              type="number"
              value={form.year}
              onChange={(e) => handleChange("year", e.target.value)}
              required
            />
            <label>Truck Type</label>
            <select
              value={form.truck_type}
              onChange={(e) => handleChange("truck_type", e.target.value)}
            >
              <option value="semi">semi</option>
              <option value="stinger_head">stinger_head</option>
              <option value="stinger_five">stinger_five</option>
              <option value="semi_platform">semi_platform</option>
              <option value="pickup">pickup</option>
              <option value="towtruck">towtruck</option>
            </select>
            <label>Coupling Type</label>
            <select
              value={form.coupling_type}
              onChange={(e) => handleChange("coupling_type", e.target.value)}
            >
              <option value="none">none</option>
              <option value="5th_wheel">5th_wheel</option>
              <option value="gooseneck">gooseneck</option>
              <option value="bumper_pool">bumper_pool</option>
            </select>
            <label>GVWR (lbs)</label>
            <input
              type="number"
              value={form.gvwr}
              onChange={(e) => handleChange("gvwr", e.target.value)}
            />
            <label>Loading Spots</label>
            <input
              type="number"
              value={form.loading_spots}
              onChange={(e) => handleChange("loading_spots", e.target.value)}
            />
            <label>Deck Count (1 or 2)</label>
            <input
              type="number"
              value={form.deck_count}
              onChange={(e) => handleChange("deck_count", e.target.value)}
            />
            <div style={{ marginTop: "8px" }}>
              <strong>Decks:</strong>{" "}
              <button type="button" onClick={addDeck}>+ Add Deck</button>
            </div>
            {decks.map((dk, i) => (
              <DeckEditor
                key={i}
                deck={dk}
                onChangeDeck={(upd) => handleDeckChange(i, upd)}
                onRemoveDeck={() => removeDeck(i)}
              />
            ))}
            <div style={{ marginTop: "8px" }}>
              <strong>Vertical Connections:</strong>{" "}
              <button type="button" onClick={addVerticalConn}>+ Add</button>
            </div>
            {verticalConns.map((vc, i) => (
              <VerticalConnectionEditor
                key={i}
                conn={vc}
                onChangeConnection={(upd) => handleVCChange(i, upd)}
                onRemove={() => removeVerticalConn(i)}
              />
            ))}
            <button type="submit">
              {editingId ? "Update Truck" : "Create Truck"}
            </button>
          </form>
        </div>
      );
    }

    // ------------------------------ VEHICLES LIST (with Edit/Delete) ------------------------------
    function VehiclesList() {
      const [items, setItems] = React.useState([]);
      const [msg, setMsg] = React.useState("");
      const [selected, setSelected] = React.useState(null); // for displaying details

      const loadAll = async () => {
        setMsg("Loading...");
        try {
          const data = await fetchAllVehicles();
          setItems(data);
          setMsg("Loaded " + data.length + " vehicles");
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      const handleDelete = async (id) => {
        if (!window.confirm("Really delete vehicle " + id + "?")) return;
        try {
          await deleteVehicle(id);
          setMsg("Deleted vehicle " + id);
          setItems(items.filter((x) => x.id !== id));
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      const handleEdit = async (item) => {
        // item => {id, type, data, created_at...}
        if (item.type !== "truck") {
          alert("Editing only implemented for trucks in this UI demo!");
          return;
        }
        // load full doc from DB
        try {
          const doc = await fetchOneVehicle(item.id);
          // doc => {id, type, data, ...}
          // let’s pass doc to the truck form
          // We'll trigger a "Truck" tab and set the fields
          setMsg("Switching to truck form for editing " + item.id);
          setActiveTab("truck");
          // a bit hacky: we have a global ref to <TruckForm/>
          if (window._truckFormRef && window._truckFormRef.loadTruck) {
            window._truckFormRef.loadTruck(doc);
          }
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      return (
        <div className="card">
          <h2>All Vehicles (List)</h2>
          <p>{msg}</p>
          <div className="inline-btns">
            <button onClick={loadAll}>Load Vehicles</button>
          </div>
          <ul>
            {items.map((v) => (
              <li key={v.id} style={{ marginBottom: "8px" }}>
                <b>Type:</b> {v.type}, <b>ID:</b> {v.id},{" "}
                <button type="button" onClick={() => setSelected(v)}>Details</button>
                <button type="button" onClick={() => handleEdit(v)}>Edit</button>
                <button type="button" onClick={() => handleDelete(v.id)}>Delete</button>
              </li>
            ))}
          </ul>
          {selected && (
            <div style={{ background: "#fff", padding: "8px", marginTop: "8px" }}>
              <h4>Vehicle details for {selected.id}</h4>
              <pre style={{ background: "#eee", padding: "8px" }}>
{JSON.stringify(selected, null, 2)}
              </pre>
              <button onClick={() => setSelected(null)}>Close</button>
            </div>
          )}
        </div>
      );
    }

    // ------------------------------ MAIN APP ------------------------------
    let setActiveTab = null; // We'll store a reference for editing

    function App() {
      const [active, _setActive] = React.useState("car");
      const [dbStatus, setDbStatus] = React.useState("Checking DB...");

      setActiveTab = _setActive; // expose

      React.useEffect(() => {
        checkDB().then(st => setDbStatus(st));
      }, []);

      // We keep a ref to the TruckForm instance so we can call loadTruck
      // from the VehiclesList when user clicks "Edit"
      const truckFormRef = React.useRef(null);

      React.useEffect(() => {
        // expose globally for simplicity
        window._truckFormRef = truckFormRef.current;
      }, []);

      return (
        <div>
          <h1>CarLogix Full Debug Interface</h1>
          <p style={{ fontStyle: "italic" }}>{dbStatus}</p>
          <div className="tabs">
            <button onClick={() => _setActive("car")}>Cars</button>
            <button onClick={() => _setActive("truck")}>Trucks</button>
            <button onClick={() => _setActive("trailer")}>Trailers</button>
            <button onClick={() => _setActive("list")}>Vehicles List</button>
          </div>
          {active === "car" && <CarTab />}
          {active === "truck" && <TruckForm ref={truckFormRef} />}
          {active === "trailer" && <TrailerTab />}
          {active === "list" && <VehiclesList />}
        </div>
      );
    }

    // To let us pass a ref to functional TruckForm, we wrap it in forwardRef
    const TruckFormWrapper = React.forwardRef((props, ref) => {
      const formRef = React.useRef(null);
      React.useImperativeHandle(ref, () => ({
        loadTruck: (doc) => {
          if (formRef.current && formRef.current.loadTruck) {
            formRef.current.loadTruck(doc);
          }
        }
      }));
      return <TruckFullForm ref={formRef} />;
    });

    // The actual "TruckFullForm" implementing logic
    function TruckFullForm(props, ref) {
      // we implement the same code from the big TruckForm above,
      // but in a functional approach. We'll do the same approach:
      const [msg, setMsg] = React.useState("");
      const [editingId, setEditingId] = React.useState(null);
      const [form, setForm] = React.useState({
        nickname: "",
        model: "",
        year: "2023",
        truck_type: "semi",
        coupling_type: "none",
        gvwr: "40000",
        loading_spots: "0",
        deck_count: "1"
      });
      const [decks, setDecks] = React.useState([]);
      const [verticalConns, setVerticalConns] = React.useState([]);

      // expose a method loadTruck
      const loadTruck = (doc) => {
        setEditingId(doc.id);
        const d = doc.data;
        setForm({
          nickname: d.nickname || "",
          model: d.truck_model || "",
          year: d.truck_year ? String(d.truck_year) : "2023",
          truck_type: d.truck_type || "semi",
          coupling_type: d.coupling_type || "none",
          gvwr: d.gvwr_lbs ? String(d.gvwr_lbs) : "40000",
          loading_spots: d.loading_spots ? String(d.loading_spots) : "0",
          deck_count: d.deck_count ? String(d.deck_count) : "1"
        });
        const ds = [];
        if (d.upper_deck) ds.push(d.upper_deck);
        if (d.lower_deck) ds.push(d.lower_deck);
        setDecks(ds);
        setVerticalConns(d.vertical_connections || []);
        setMsg("Editing existing truck " + doc.id);
      };

      React.useImperativeHandle(ref, () => ({
        loadTruck
      }));

      const handleForm = (field, val) => {
        setForm({ ...form, [field]: val });
      };

      const addDeck = () => {
        const newDeck = {
          type: "upper_deck",
          total_length: 0,
          platforms: [],
          joints: []
        };
        setDecks([...decks, newDeck]);
      };

      const removeDeck = (idx) => {
        const newDs = [...decks];
        newDs.splice(idx, 1);
        setDecks(newDs);
      };

      const handleDeckChange = (idx, updated) => {
        const newDs = [...decks];
        newDs[idx] = updated;
        setDecks(newDs);
      };

      const addVC = () => {
        const newVC = {
          upper_platform_id: "",
          lower_platform_id: "",
          clearance_profile: {},
          min_clearance: 0
        };
        setVerticalConns([...verticalConns, newVC]);
      };

      const removeVC = (idx) => {
        const newVs = [...verticalConns];
        newVs.splice(idx, 1);
        setVerticalConns(newVs);
      };

      const handleVCChange = (idx, updated) => {
        const newVs = [...verticalConns];
        newVs[idx] = updated;
        setVerticalConns(newVs);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setMsg("");
        const payload = {
          type: "truck",
          nickname: form.nickname,
          truck_model: form.model,
          truck_year: parseInt(form.year, 10),
          truck_type: form.truck_type,
          coupling_type: form.coupling_type,
          gvwr_lbs: parseFloat(form.gvwr),
          loading_spots: parseInt(form.loading_spots, 10),
          deck_count: parseInt(form.deck_count, 10)
        };
        if (decks[0]) payload.upper_deck = decks[0];
        if (decks[1]) payload.lower_deck = decks[1];
        if (verticalConns.length > 0) payload.vertical_connections = verticalConns;

        try {
          let data;
          if (!editingId) {
            data = await createVehicle(payload);
            setMsg("Truck created! ID=" + data.id);
          } else {
            data = await updateVehicle(editingId, payload);
            setMsg("Truck updated! ID=" + data.id);
          }
          // reset
          setEditingId(null);
          setForm({
            nickname: "",
            model: "",
            year: "2023",
            truck_type: "semi",
            coupling_type: "none",
            gvwr: "40000",
            loading_spots: "0",
            deck_count: "1"
          });
          setDecks([]);
          setVerticalConns([]);
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      return (
        <div className="card">
          <h2>{editingId ? "Edit Truck" : "Create Truck"} (Full Specification)</h2>
          {msg && <div>{msg}</div>}
          <form onSubmit={handleSubmit}>
            <label>Nickname</label>
            <input
              value={form.nickname}
              onChange={(e) => handleForm("nickname", e.target.value)}
              required
            />
            <label>Model</label>
            <input
              value={form.model}
              onChange={(e) => handleForm("model", e.target.value)}
              required
            />
            <label>Year</label>
            <input
              type="number"
              value={form.year}
              onChange={(e) => handleForm("year", e.target.value)}
              required
            />
            <label>Truck Type</label>
            <select
              value={form.truck_type}
              onChange={(e) => handleForm("truck_type", e.target.value)}
            >
              <option value="semi">semi</option>
              <option value="stinger_head">stinger_head</option>
              <option value="stinger_five">stinger_five</option>
              <option value="semi_platform">semi_platform</option>
              <option value="pickup">pickup</option>
              <option value="towtruck">towtruck</option>
            </select>
            <label>Coupling Type</label>
            <select
              value={form.coupling_type}
              onChange={(e) => handleForm("coupling_type", e.target.value)}
            >
              <option value="none">none</option>
              <option value="5th_wheel">5th_wheel</option>
              <option value="gooseneck">gooseneck</option>
              <option value="bumper_pool">bumper_pool</option>
            </select>
            <label>GVWR (lbs)</label>
            <input
              type="number"
              value={form.gvwr}
              onChange={(e) => handleForm("gvwr", e.target.value)}
            />
            <label>Loading Spots</label>
            <input
              type="number"
              value={form.loading_spots}
              onChange={(e) => handleForm("loading_spots", e.target.value)}
            />
            <label>Deck Count</label>
            <input
              type="number"
              value={form.deck_count}
              onChange={(e) => handleForm("deck_count", e.target.value)}
            />

            {/* Decks */}
            <div style={{ marginTop: "8px" }}>
              <strong>Decks:</strong>{" "}
              <button type="button" onClick={addDeck}>+ Add Deck</button>
            </div>
            {decks.map((dk, i) => (
              <DeckEditor
                key={i}
                deck={dk}
                onChangeDeck={(upd) => handleDeckChange(i, upd)}
                onRemoveDeck={() => {
                  const newDs = [...decks];
                  newDs.splice(i, 1);
                  setDecks(newDs);
                }}
              />
            ))}

            {/* Vertical Connections */}
            <div style={{ marginTop: "8px" }}>
              <strong>Vertical Connections:</strong>{" "}
              <button type="button" onClick={addVC}>+ Add Connection</button>
            </div>
            {verticalConns.map((vc, i) => (
              <VerticalConnectionEditor
                key={i}
                conn={vc}
                onChangeConnection={(upd) => handleVCChange(i, upd)}
                onRemove={() => {
                  const newVC = [...verticalConns];
                  newVC.splice(i, 1);
                  setVerticalConns(newVC);
                }}
              />
            ))}

            <button type="submit" style={{ marginTop: "12px" }}>
              {editingId ? "Update Truck" : "Create Truck"}
            </button>
          </form>
        </div>
      );
    }

    const TruckFormRef = React.forwardRef(TruckFullForm);

    // ------------------------------ MAIN APP RENDER ------------------------------
    function MainApp() {
      const [activeTab, setActiveTab] = React.useState("car");
      const [dbStatus, setDbStatus] = React.useState("Checking DB...");

      React.useEffect(() => {
        checkDB().then(st => setDbStatus(st));
      }, []);

      return (
        <div>
          <h1>CarLogix Full Debug Interface</h1>
          <p style={{ fontStyle: "italic" }}>{dbStatus}</p>
          <div className="tabs">
            <button onClick={() => setActiveTab("car")}>Cars</button>
            <button onClick={() => setActiveTab("truck")}>Trucks</button>
            <button onClick={() => setActiveTab("trailer")}>Trailers</button>
            <button onClick={() => setActiveTab("list")}>Vehicles</button>
          </div>

          {activeTab === "car" && <CarTab />}
          {activeTab === "truck" && <TruckFormRef />}
          {activeTab === "trailer" && <TrailerTab />}
          {activeTab === "list" && <VehiclesList />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<MainApp />);
  </script>
</body>
</html>