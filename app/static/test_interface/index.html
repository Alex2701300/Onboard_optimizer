<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CarLogix Full Debug Interface</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/javascript">
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Ошибка:', message);
      console.error('Источник:', source);
      console.error('Строка:', lineno);
      console.error('Колонка:', colno);
      console.error('Стек ошибки:', error && error.stack);
      return false;
    };
  </script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary: #3b82f6;
      --success: #22c55e;
      --error: #ef4444;
      --background: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
      --radius-lg: 12px;
      --radius-md: 8px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --space-unit: 1rem;
    }
    * {
      box-sizing: border-box; margin: 0; padding: 0;
    }
    body {
      margin: 0; padding: var(--space-unit);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background); color: var(--text);
      line-height: 1.5;
    }
    #root { max-width: 1200px; margin: 0 auto; }
    h1, h2, h3 {
      font-weight: 600; color: #1e3a8a; margin-bottom: 1.5rem;
    }
    h1 {
      font-size: 2.25rem; letter-spacing: -0.025em;
      margin-bottom: 2rem; position: relative;
      padding-bottom: 0.5rem;
    }
    h1::after {
      content: ''; position: absolute; bottom: 0; left: 0;
      width: 64px; height: 3px; background: var(--primary);
      border-radius: 2px;
    }
    .tabs {
      display: flex; gap: 0.5rem; margin-bottom: 2rem; position: relative;
      padding-bottom: 2px;
    }
    .tabs::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0;
      height: 2px; background: var(--border); z-index: 0;
    }
    .tabs button {
      padding: 0.75rem 1.5rem; border: none; background: none;
      border-radius: var(--radius-md); cursor: pointer; font-weight: 500;
      transition: all 0.2s ease; color: #64748b; position: relative;
      z-index: 1; display: flex; align-items: center; gap: 0.5rem;
    }
    .tabs button:hover {
      color: var(--primary); background: rgba(37, 99, 235, 0.05);
    }
    .card {
      background: var(--card-bg); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md); padding: 2rem; margin-bottom: 1.5rem;
      border: 1px solid var(--border);
    }
    .card h2 {
      font-size: 1.5rem; margin-bottom: 1.5rem;
      display: flex; align-items: center; gap: 0.75rem;
    }
    label {
      display: block; font-weight: 500; margin-bottom: 0.5rem;
      color: #334155; font-size: 0.875rem;
    }
    input, select, textarea {
      width: 100%; padding: 0.75rem; border: 2px solid var(--border);
      border-radius: var(--radius-md); font-size: 1rem;
      transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary); outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    button {
      padding: 0.75rem 1.5rem; border: none; border-radius: var(--radius-md);
      font-weight: 500; cursor: pointer; transition: all 0.2s ease;
      display: inline-flex; align-items: center; gap: 0.5rem;
    }
    button.primary {
      background: var(--primary); color: white;
    }
    button.primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }
    .sub-block {
      background: rgba(241, 245, 249, 0.5); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 1.5rem; margin: 1.5rem 0;
      position: relative;
    }
    .sub-block .sub-title {
      font-weight: 600; margin-bottom: 1rem; color: var(--primary);
      display: flex; align-items: center; gap: 0.5rem;
    }
    .validation-error { border-color: var(--error)!important; }
    .error-message {
      color: var(--error); font-size: 0.875rem; margin-top: 0.25rem;
    }
  </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

  // ------------------ 1) Check DB Util ------------------
  async function checkDB() {
    try {
      const res = await fetch("/api/cars");
      if (!res.ok && res.status !== 404) throw new Error("Status=" + res.status);
      return "MongoDB connected ✔";
    } catch(err) {
      return "DB error: " + err.message;
    }
  }

  // ------------------ 2) Cars CRUD ------------------
  async function createCar(payload) {
    const res = await fetch("/api/cars", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || "Create car error");
    }
    return await res.json();
  }
  async function listCars() {
    const res = await fetch("/api/cars");
    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.detail||"List cars error");
    }
    return await res.json();
  }

  // ------------------ 3) Trucks CRUD ------------------
  async function createTruck(payload) {
    const res = await fetch("/api/trucks", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.detail||"Create truck error");
    }
    return await res.json();
  }
  async function listTrucks() {
    const res = await fetch("/api/trucks");
    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.detail||"List trucks error");
    }
    const data = await res.json();
    data.forEach(d => {
      if(d._id && !d.id) d.id = d._id;
    });
    return data;
  }
  async function getTruck(truck_id) {
    const res = await fetch("/api/trucks/"+truck_id);
    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.detail||"Get truck error");
    }
    const doc = await res.json();
    if(doc._id && !doc.id) doc.id=doc._id;
    return doc;
  }
  async function updateTruck(truck_id, updates) {
    const res = await fetch("/api/trucks/"+truck_id, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(updates)
    });
    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.detail||"Update truck error");
    }
    return await res.json();
  }
  async function deleteTruck(truck_id) {
    const res = await fetch("/api/trucks/"+truck_id, {
      method:"DELETE"
    });
    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.detail||"Delete truck error");
    }
    return true;
  }

  // ------------------ 4) Trailers CRUD ------------------
  async function createTrailer(payload) {
    const res = await fetch("/api/trailers", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.detail||"Create trailer error");
    }
    return await res.json();
  }
  async function listTrailers() {
    const res = await fetch("/api/trailers");
    if(!res.ok) {
      const err = await res.json();
      throw new Error(err.detail||"List trailers error");
    }
    const data = await res.json();
    data.forEach(d => {
      if(d._id && !d.id) d.id = d._id;
    });
    return data;
  }

  // ------------------ 5) CarTab ------------------
  function CarTab(){
    const [msg,setMsg] = React.useState("");
    const [form,setForm] = React.useState({
      vin: "1G1YZ26E895111766",
      make: "Ford",
      model:"Focus",
      year:"2023",
      length_in:"200",
      width_in:"80",
      height_ft:"5",
      wheelbase_in:"110"
    });

    const handleSubmit = async(e)=>{
      e.preventDefault();
      setMsg("");
      const payload = {
        vin: form.vin,
        make: form.make,
        model: form.model,
        year:parseInt(form.year,10),
        length_in:parseFloat(form.length_in),
        width_in:parseFloat(form.width_in),
        height_ft:parseFloat(form.height_ft),
        wheelbase_in:parseFloat(form.wheelbase_in)
      };
      try {
        const data = await createCar(payload);
        setMsg("Успешно создано! Car ID="+data.id);
      } catch(err) {
        setMsg("Error: "+err.message);
      }
    };

    return (
      <div className="card">
        <h2>Create Car (all dims in inches/feet)</h2>
        {msg && <div>{msg}</div>}
        <form onSubmit={handleSubmit}>
          <label>VIN</label>
          <input
            value={form.vin}
            onChange={(e)=> setForm({...form, vin:e.target.value})}
          />
          <label>Make</label>
          <input
            value={form.make}
            onChange={(e)=> setForm({...form, make:e.target.value})}
            required
          />
          <label>Model</label>
          <input
            value={form.model}
            onChange={(e)=> setForm({...form, model:e.target.value})}
            required
          />
          <label>Year</label>
          <input
            type="number"
            value={form.year}
            onChange={(e)=> setForm({...form, year:e.target.value})}
            required
          />
          <label>Length (inches)</label>
          <input
            type="number"
            value={form.length_in}
            onChange={(e)=> setForm({...form, length_in:e.target.value})}
          />
          <label>Width (inches)</label>
          <input
            type="number"
            value={form.width_in}
            onChange={(e)=> setForm({...form, width_in:e.target.value})}
          />
          <label>Height (feet)</label>
          <input
            type="number"
            value={form.height_ft}
            onChange={(e)=> setForm({...form, height_ft:e.target.value})}
          />
          <label>Wheelbase (inches)</label>
          <input
            type="number"
            value={form.wheelbase_in}
            onChange={(e)=> setForm({...form, wheelbase_in:e.target.value})}
          />
          <button type="submit">Create Car</button>
        </form>
      </div>
    );
  }

  // ------------------ 6) TrailerTab ------------------
  function TrailerTab(){
    const [msg,setMsg] = React.useState("");
    const [form,setForm] = React.useState({
      vin:"",
      nickname:"My Trailer",
      year:"2023",
      capacity_in:"500"
    });

    const handleSubmit = async(e)=>{
      e.preventDefault();
      setMsg("");
      const payload = {
        vin: form.vin||null,
        nickname: form.nickname,
        year: parseInt(form.year,10),
        capacity_in: parseFloat(form.capacity_in)
      };
      try {
        const data = await createTrailer(payload);
        setMsg("Успешно создано! Trailer ID="+data.id);
      } catch(err) {
        setMsg("Error: "+err.message);
      }
    };

    return (
      <div className="card">
        <h2>Create Trailer</h2>
        {msg && <div>{msg}</div>}
        <form onSubmit={handleSubmit}>
          <label>VIN (optional)</label>
          <input
            value={form.vin}
            onChange={(e)=> setForm({...form, vin:e.target.value})}
          />
          <label>Nickname</label>
          <input
            value={form.nickname}
            onChange={(e)=> setForm({...form, nickname:e.target.value})}
            required
          />
          <label>Year</label>
          <input
            type="number"
            value={form.year}
            onChange={(e)=> setForm({...form, year:e.target.value})}
            required
          />
          <label>Capacity (inches)</label>
          <input
            type="number"
            value={form.capacity_in}
            onChange={(e)=> setForm({...form, capacity_in:e.target.value})}
          />
          <button type="submit">Create Trailer</button>
        </form>
      </div>
    );
  }

  // ------------------ 7) Full Truck Editor (Decks, Joints, etc.) ------------------

  // JointEdgeSelect: выбор "a-Plat" / "b-Plat"
  function JointEdgeSelect({ label, platforms, selected, onChange }) {
    const handleChange = (v) => onChange(v);
    return (
      <div>
        <label>{label}</label>
        <select value={selected||""} onChange={(e)=>handleChange(e.target.value)}>
          <option value="">(none)</option>
          {platforms.map((plat) => (
            <React.Fragment key={plat.id}>
              <option value={`a-${plat.id}`}>a-{plat.id}</option>
              <option value={`b-${plat.id}`}>b-{plat.id}</option>
            </React.Fragment>
          ))}
        </select>
      </div>
    );
  }

  // EdgeEditor c min_height, max_height, hydraulic
  function EdgeEditor({edge, onChangeEdge}) {
    const handle = (field, val) => {
      onChangeEdge({...edge, [field]: val});
    };
    const isMobile = edge.type==="mobile";

    return (
      <div className="sub-block" style={{ background:"#fefefe" }}>
        <div className="sub-title">Edge</div>
        <label>Edge Type</label>
        <select
          value={edge.type||"static"}
          onChange={(e)=>handle("type", e.target.value)}
        >
          <option value="static">static</option>
          <option value="mobile">mobile</option>
        </select>
        <label>Height (inches)</label>
        <input
          type="number"
          value={edge.height||""}
          onChange={(e)=>handle("height", parseFloat(e.target.value)||0)}
        />

        <label>Has Chains?</label>
        <input
          type="checkbox"
          checked={edge.chains||false}
          onChange={(e)=>handle("chains", e.target.checked)}
        />

        {isMobile && (
          <>
            <label>Min Height</label>
            <input
              type="number"
              value={edge.min_height||""}
              onChange={(e)=>handle("min_height", parseFloat(e.target.value)||0)}
            />
            <label>Max Height</label>
            <input
              type="number"
              value={edge.max_height||""}
              onChange={(e)=>handle("max_height", parseFloat(e.target.value)||0)}
            />
            <label>Hydraulic Drive</label>
            <input
              type="checkbox"
              checked={edge.is_hydraulic||false}
              onChange={(e)=>handle("is_hydraulic", e.target.checked)}
            />
          </>
        )}
      </div>
    );
  }

  // SlideEditor
  function SlideEditor({slide, onChangeSlide}) {
    const handle = (f,v) => onChangeSlide({...slide, [f]: v});
    return (
      <div className="sub-block" style={{ background:"#f7fcff" }}>
        <div className="sub-title">Slide (optional)</div>
        <label>Type</label>
        <select
          value={slide.type||"none"}
          onChange={(e)=>handle("type", e.target.value)}
        >
          <option value="none">none</option>
          <option value="platform_slide">platform_slide</option>
          <option value="a_slide">a_slide</option>
          <option value="b_slide">b_slide</option>
        </select>
        <label>Min Length</label>
        <input
          type="number"
          value={slide.min_length||""}
          onChange={(e)=>handle("min_length", parseFloat(e.target.value)||0)}
        />
        <label>Max Length</label>
        <input
          type="number"
          value={slide.max_length||""}
          onChange={(e)=>handle("max_length", parseFloat(e.target.value)||0)}
        />
        <label>Min Distance</label>
        <input
          type="number"
          value={slide.min_distance||""}
          onChange={(e)=>handle("min_distance", parseFloat(e.target.value)||0)}
        />
        <label>Max Distance</label>
        <input
          type="number"
          value={slide.max_distance||""}
          onChange={(e)=>handle("max_distance", parseFloat(e.target.value)||0)}
        />
      </div>
    );
  }

  // JointEditor
  function JointEditor({joint, onChangeJoint, onRemove, platforms}) {
    const handle = (f,v) => onChangeJoint({...joint, [f]:v});

    return (
      <div className="sub-block" style={{ background:"#fafafa" }}>
        <div className="sub-title">Joint
          <button type="button" onClick={onRemove} style={{ float:"right" }}>Remove</button>
        </div>
        <label>Type</label>
        <select
          value={joint.type||"static_joint"}
          onChange={(e)=>handle("type", e.target.value)}
        >
          <option value="static_joint">static_joint</option>
          <option value="open_free_joint">open_free_joint</option>
          <option value="articulated_sliding_joint">articulated_sliding_joint</option>
          <option value="semi_open_free_joint">semi_open_free_joint</option>
          <option value="semi_fix_joint">semi_fix_joint</option>
          <option value="turning_joint">turning_joint</option>
        </select>

        <JointEdgeSelect
          label="Edge A"
          platforms={platforms}
          selected={joint.edge_a}
          onChange={(val)=>handle("edge_a", val)}
        />
        <JointEdgeSelect
          label="Edge B"
          platforms={platforms}
          selected={joint.edge_b}
          onChange={(val)=>handle("edge_b", val)}
        />

        <label>Minimum Loading Distance</label>
        <input
          type="number"
          value={joint.minimum_loading_distance||""}
          onChange={(e)=>handle("minimum_loading_distance", parseFloat(e.target.value)||0)}
        />
        <label>Max Overlap</label>
        <input
          type="number"
          value={joint.max_overlap||""}
          onChange={(e)=>handle("max_overlap", parseFloat(e.target.value)||0)}
        />
      </div>
    );
  }

  // PlatformEditor
  function PlatformEditor({platform, onChangePlatform, onRemove}) {
    const handle = (f,v) => onChangePlatform({...platform, [f]:v});
    return (
      <div className="sub-block" style={{ background:"#fffdf0" }}>
        <div className="sub-title">
          Platform {platform.id||""}
          <button type="button" style={{ float:"right" }} onClick={onRemove}>Remove</button>
        </div>
        <label>Platform ID</label>
        <input
          value={platform.id||""}
          onChange={(e)=>handle("id", e.target.value)}
        />
        <label>Deck Type</label>
        <select
          value={platform.deck_type||"upper_deck"}
          onChange={(e)=>handle("deck_type", e.target.value)}
        >
          <option value="upper_deck">upper_deck</option>
          <option value="lower_deck">lower_deck</option>
        </select>
        <label>Position (front->rear ordinal)</label>
        <input
          type="number"
          value={platform.position||""}
          onChange={(e)=>handle("position", parseInt(e.target.value)||0)}
        />
        <label>Default Length (inches)</label>
        <input
          type="number"
          value={platform.default_length||0}
          onChange={(e)=>handle("default_length", parseFloat(e.target.value)||0)}
        />

        {/* Edges */}
        <h4>Edge A</h4>
        <EdgeEditor
          edge={platform.edge_a||{type:"static", height:50}}
          onChangeEdge={(upd)=>handle("edge_a",upd)}
        />
        <h4>Edge B</h4>
        <EdgeEditor
          edge={platform.edge_b||{type:"static", height:50}}
          onChangeEdge={(upd)=>handle("edge_b",upd)}
        />

        {/* Slide */}
        <h4>Slide (optional)</h4>
        {platform.slide? (
          <SlideEditor
            slide={platform.slide}
            onChangeSlide={(upd)=>handle("slide",upd)}
          />
        ) : (
          <button type="button" onClick={()=>handle("slide",{
            type:"none",min_length:0,max_length:0, min_distance:0,max_distance:0
          })}>
            + Add Slide
          </button>
        )}
      </div>
    );
  }

  // DeckEditor
  function DeckEditor({deck, onChangeDeck, onRemoveDeck, globalPlatformCount, setGlobalPlatformCount}) {
    const handle = (f,v) => onChangeDeck({...deck, [f]: v});

    // Автосумма total_length
    React.useEffect(()=>{
      const sum = deck.platforms.reduce((acc,p)=> acc+(p.default_length||0),0);
      if(sum!==deck.total_length) {
        onChangeDeck({...deck, total_length: sum});
      }
    },[deck.platforms]);

    // Добавить платформу
    const addPlatform = () => {
      const newNum = globalPlatformCount+1;
      const newId = "Plat"+newNum;
      const newP = {
        id:newId, deck_type: deck.type, position: deck.platforms.length+1,
        default_length:200,
        edge_a:{type:"static", height:50},
        edge_b:{type:"static", height:50},
        slide:null
      };
      onChangeDeck({...deck, platforms:[...deck.platforms,newP]});
      setGlobalPlatformCount(newNum);
    };

    // Удалить платформу
    const removePlatform = (idx) => {
      const arr = [...deck.platforms];
      arr.splice(idx,1);
      onChangeDeck({...deck, platforms: arr});
    };

    const handlePlatformChange = (idx, updated) => {
      const arr = [...deck.platforms];
      arr[idx] = updated;
      onChangeDeck({...deck, platforms: arr});
    };

    // Joints
    const allPlatformsValid = deck.platforms.every(p=> p.id && p.default_length>0);
    const addJoint = () => {
      const j = {
        type:"static_joint",
        edge_a:"",
        edge_b:"",
        minimum_loading_distance:0,
        max_overlap:0
      };
      onChangeDeck({...deck, joints:[...deck.joints, j]});
    };
    const removeJoint = (idx) => {
      const arr = [...deck.joints];
      arr.splice(idx,1);
      onChangeDeck({...deck, joints: arr});
    };
    const handleJointChange = (idx,upd) => {
      const arr = [...deck.joints];
      arr[idx]=upd;
      onChangeDeck({...deck, joints:arr});
    };

    // Сортируем платформы
    const sortedPlats = [...deck.platforms].sort((a,b)=>a.position-b.position);

    return (
      <div className="sub-block" style={{ background:"#fffae7" }}>
        <div className="sub-title">
          Deck: {deck.type}
          <button type="button" onClick={onRemoveDeck} style={{ float:"right" }}>Remove Deck</button>
        </div>

        <label>Deck Type</label>
        <select
          value={deck.type||"upper_deck"}
          onChange={(e)=>handle("type", e.target.value)}
        >
          <option value="upper_deck">upper_deck</option>
          <option value="lower_deck">lower_deck</option>
        </select>

        <label>Total Length (auto-sum)</label>
        <input
          type="number"
          readOnly
          value={deck.total_length||0}
        />

        <h4>Platforms</h4>
        <button type="button" onClick={addPlatform}>+ Add Platform</button>
        {deck.platforms.map((p,i)=>(
          <PlatformEditor
            key={p.id||i}
            platform={p}
            onChangePlatform={(upd)=>handlePlatformChange(i,upd)}
            onRemove={()=> removePlatform(i)}
          />
        ))}

        <h4>Joints</h4>
        {allPlatformsValid ? (
          <>
            <button type="button" onClick={addJoint}>+ Add Joint</button>
            {deck.joints.map((j,i)=>(
              <JointEditor
                key={i}
                joint={j}
                onChangeJoint={(upd)=>handleJointChange(i,upd)}
                onRemove={()=>removeJoint(i)}
                platforms={sortedPlats}
              />
            ))}
          </>
        ) : (
          <div style={{ opacity:0.6 }}>
            <p>Complete all platforms first to enable Joints</p>
            <button type="button" disabled>+ Add Joint</button>
          </div>
        )}
      </div>
    );
  }

  // VerticalConnectionEditor
  function VerticalConnectionEditor({vc, onChangeVC, onRemove}) {
    const handle = (f,v) => onChangeVC({...vc, [f]:v});
    const parseProfile=(text)=>{
      const out={};
      text.split(",").forEach(chunk=>{
        const [k,v] = chunk.split("=").map(x=>x.trim());
        if(k) out[k]= parseFloat(v)||0;
      });
      handle("clearance_profile", out);
    };
    const makeProfileString=()=>{
      if(!vc.clearance_profile) return "";
      return Object.entries(vc.clearance_profile)
        .map(([k,v])=>`${k}=${v}`)
        .join(",");
    };

    return (
      <div className="sub-block" style={{ background:"#fff3f3" }}>
        <div className="sub-title">
          Vertical Conn
          <button type="button" style={{ float:"right" }} onClick={onRemove}>Remove</button>
        </div>
        <label>Upper Platform ID</label>
        <input
          value={vc.upper_platform_id||""}
          onChange={(e)=>handle("upper_platform_id", e.target.value)}
        />
        <label>Lower Platform ID</label>
        <input
          value={vc.lower_platform_id||""}
          onChange={(e)=>handle("lower_platform_id", e.target.value)}
        />
        <label>Clearance Profile (like "front=72,middle=70")</label>
        <textarea
          rows={2}
          value={makeProfileString()}
          onChange={(e)=> parseProfile(e.target.value)}
        />
        <label>Min Clearance (inches)</label>
        <input
          type="number"
          value={vc.min_clearance||6}
          onChange={(e)=> handle("min_clearance", parseFloat(e.target.value)||6)}
        />
      </div>
    );
  }

  // TruckFullEditor
  function TruckFullEditor(){
    const [msg,setMsg] = React.useState("");
    const [editingId,setEditingId] = React.useState(null);
    const [truckList,setTruckList] = React.useState([]);
    const [showConfirm,setShowConfirm] = React.useState(false);

    // Счётчик для глобального именования платформ
    const [globalPlatformCount,setGlobalPlatformCount] = React.useState(0);

    // Основная форма
    const [form,setForm] = React.useState({
      vin:"",
      nickname:"FullSpec Truck",
      model:"Peterbilt 389",
      year:"2023",
      truck_type:"semi",
      coupling_type:"none",
      gvwr:"40000",
      loading_spots:"0",
      deck_count:"1"
    });

    // Списки палуб
    const [decks,setDecks] = React.useState([]);
    // Vertical connections
    const [verticalConns,setVerticalConns] = React.useState([]);

    // Загрузка списка траков
    React.useEffect(()=>{
      listTrucks().then(res=> setTruckList(res))
                  .catch(err=> setMsg("Error listing trucks: "+err.message));
    },[]);

    // Синхронизировать количество палуб
    React.useEffect(()=>{
      const dCount = parseInt(form.deck_count,10);
      if(dCount<1) {
        setForm({...form, deck_count:"1"});
        return;
      }
      if(dCount>2) {
        setForm({...form, deckcount:"2"});
        return;
      }
      if(decks.length<dCount) {
        const needed = dCount - decks.length;
        const arr = [...decks];
        for(let i=0; i<needed; i++){
          arr.push({
            type: arr.length===0?"upper_deck":"lower_deck",
            total_length:0,
            platforms:[],
            joints:[]
          });
        }
        setDecks(arr);
      } else if(decks.length>dCount) {
        setDecks(decks.slice(0,dCount));
      }
    },[form.deck_count]);

    const handleForm=(field,val)=>{
      setForm({...form, [field]:val});
    };

    // Удаление трака
    const removeTruck= async(id)=>{
      if(!confirm("Delete truck "+id+"?")) return;
      try {
        await deleteTruck(id);
        setMsg("Deleted truck "+id);
        setTruckList(await listTrucks());
      } catch(err) {
        setMsg("Error: "+err.message);
      }
    };

    // Редактирование
    const loadTruck= async(id)=>{
      setMsg("Loading truck "+id);
      try {
        const doc= await getTruck(id);
        setEditingId(doc.id);
        setForm({
          vin: doc.vin||"",
          nickname: doc.nickname||"",
          model: doc.model||"",
          year: doc.year?String(doc.year):"2023",
          truck_type: doc.truck_type||"semi",
          coupling_type: doc.coupling_type||"none",
          gvwr: doc.gvwr?String(doc.gvwr):"40000",
          loading_spots: doc.loading_spots?String(doc.loading_spots):"0",
          deck_count: doc.deck_count?String(doc.deck_count):"1"
        });
        const arr=[];
        if(doc.upper_deck) arr.push(doc.upper_deck);
        if(doc.lower_deck) arr.push(doc.lower_deck);
        setDecks(arr);
        const maxNum= arr.reduce((acc,dk)=>{
          dk.platforms.forEach(pl=>{
            const num = parseInt(pl.id.replace("Plat",""),10);
            if(!isNaN(num) && num>acc) acc=num;
          });
          return acc;
        },0);
        setGlobalPlatformCount(maxNum);
        setVerticalConns(doc.vertical_connections||[]);
        setMsg("Editing truck "+doc.id);
      } catch(err) {
        setMsg("Error loading truck: "+err.message);
      }
    };

    // Удаление палубы
    const removeDeck=(idx)=>{
      const arr=[...decks]; arr.splice(idx,1);
      setDecks(arr);
    };
    // Обновление палубы
    const handleDeckChange=(idx,upd)=>{
      const arr=[...decks];
      arr[idx]=upd;
      setDecks(arr);
    };

    // Vertical connections
    const addVC= ()=>{
      setVerticalConns([...verticalConns,{
        upper_platform_id:"",
        lower_platform_id:"",
        clearance_profile:{},
        min_clearance:6
      }]);
    };
    const removeVC=(idx)=>{
      const arr=[...verticalConns];
      arr.splice(idx,1);
      setVerticalConns(arr);
    };
    const handleVCChange=(idx,upd)=>{
      const arr=[...verticalConns];
      arr[idx]=upd;
      setVerticalConns(arr);
    };

    // Submit
    const handleSubmit=(e)=>{
      e.preventDefault();
      setMsg("");
      // Просто вызываем диалог подтверждения
      setShowConfirm(true);
    };

    const doSaveTruck= async()=>{
      setShowConfirm(false);
      const payload={
        vin: form.vin||null,
        nickname: form.nickname,
        model: form.model,
        year: parseInt(form.year,10),
        truck_type: form.truck_type,
        coupling_type: form.coupling_type,
        gvwr: parseFloat(form.gvwr),
        loading_spots: parseInt(form.loading_spots,10),
        deck_count: parseInt(form.deck_count,10)
      };
      if(decks[0]) payload.upper_deck=decks[0];
      if(decks[1]) payload.lower_deck=decks[1];
      if(verticalConns.length>0) payload.vertical_connections=verticalConns;

      try {
        if(!editingId) {
          const cr= await createTruck(payload);
          setMsg("Created Truck ID="+cr.id);
        } else {
          const upd= await updateTruck(editingId,payload);
          setMsg("Updated Truck ID="+upd.id);
        }
        setEditingId(null);
        setForm({
          vin:"",
          nickname:"",
          model:"",
          year:"2023",
          truck_type:"semi",
          coupling_type:"none",
          gvwr:"40000",
          loading_spots:"0",
          deck_count:"1"
        });
        setDecks([]);
        setGlobalPlatformCount(0);
        setVerticalConns([]);
        setTruckList(await listTrucks());
      } catch(err) {
        setMsg("Error saving truck: "+err.message);
      }
    };

    return (
      <div>
        <div className="card">
          <h2>{editingId?"Edit Truck (Full Spec)":"Create Truck (Full Spec)"}</h2>
          {msg && <div>{msg}</div>}
          <form onSubmit={handleSubmit}>
            <label>VIN (optional)</label>
            <input
              value={form.vin}
              onChange={(e)=> setForm({...form, vin:e.target.value})}
            />
            <label>Nickname</label>
            <input
              value={form.nickname}
              onChange={(e)=> setForm({...form, nickname:e.target.value})}
              required
            />
            <label>Model</label>
            <input
              value={form.model}
              onChange={(e)=> setForm({...form, model:e.target.value})}
              required
            />
            <label>Year</label>
            <input
              type="number"
              value={form.year}
              onChange={(e)=> setForm({...form, year:e.target.value})}
              required
            />
            <label>Truck Type</label>
            <select
              value={form.truck_type}
              onChange={(e)=> setForm({...form, truck_type:e.target.value})}
            >
              <option value="semi">semi</option>
              <option value="stinger_head">stinger_head</option>
              <option value="stinger_five">stinger_five</option>
              <option value="semi_platform">semi_platform</option>
              <option value="pickup">pickup</option>
              <option value="towtruck">towtruck</option>
            </select>
            <label>Coupling Type</label>
            <select
              value={form.coupling_type}
              onChange={(e)=> setForm({...form, coupling_type:e.target.value})}
            >
              <option value="none">none</option>
              <option value="5th_wheel">5th_wheel</option>
              <option value="gooseneck">gooseneck</option>
              <option value="bumper_pool">bumper_pool</option>
            </select>
            <label>GVWR (lbs)</label>
            <input
              type="number"
              value={form.gvwr}
              onChange={(e)=> setForm({...form, gvwr:e.target.value})}
            />
            <label>Loading Spots</label>
            <input
              type="number"
              value={form.loading_spots}
              onChange={(e)=> setForm({...form, loading_spots:e.target.value})}
            />
            <label>Deck Count (1 or 2)</label>
            <input
              type="number"
              value={form.deck_count}
              onChange={(e)=> setForm({...form, deck_count:e.target.value})}
            />

            {/* Render decks */}
            {decks.map((dk, i)=>(
              <div key={i} style={{
                border:"1px dashed #ccc", padding:"1rem", margin:"1rem 0"
              }}>
                <DeckEditor
                  deck={dk}
                  onChangeDeck={(upd)=> handleDeckChange(i,upd)}
                  onRemoveDeck={()=> removeDeck(i)}
                  globalPlatformCount={globalPlatformCount}
                  setGlobalPlatformCount={setGlobalPlatformCount}
                />
              </div>
            ))}

            {/* Vertical connections */}
            <h4>Vertical Connections</h4>
            <button type="button" onClick={addVC}>+ Add VerticalConn</button>
            {verticalConns.map((vc,idx)=>(
              <VerticalConnectionEditor
                key={idx}
                vc={vc}
                onChangeVC={(upd)=>{
                  const arr=[...verticalConns]; arr[idx]=upd;
                  setVerticalConns(arr);
                }}
                onRemove={()=> removeVC(idx)}
              />
            ))}

            <button type="submit" style={{ marginTop:"12px" }}>
              {editingId?"Update Truck":"Create Truck"}
            </button>
          </form>

          {/* Final confirmation */}
          {showConfirm && (
            <div style={{
              background:"#fff", border:"1px solid #ccc", padding:"1rem", marginTop:"1rem"
            }}>
              <h3>Confirm Final Truck?</h3>
              <p>You have {form.deck_count} deck(s). Continue?</p>
              <button
                style={{ background:"#c3fbc2", marginRight:"0.5rem" }}
                onClick={doSaveTruck}
              >
                Confirm
              </button>
              <button onClick={()=>setShowConfirm(false)}>Cancel</button>
            </div>
          )}
        </div>

        <div className="card">
          <h2>Current Trucks List</h2>
          {truckList.map((tk) => (
            <div key={tk.id} style={{
              border:"1px solid #ccc", background:"#f9fafb",
              padding:"1rem", marginBottom:"1rem"
            }}>
              ID={tk.id||""}, VIN={tk.vin||"N/A"}, Nickname={tk.nickname||""}, 
              Year={tk.year||"?"}
              <br/>
              <button
                style={{ marginRight:"1rem", background:"#eee" }}
                onClick={()=>loadTruck(tk.id)}
              >
                Edit
              </button>
              <button
                style={{ background:"#ffe5e5" }}
                onClick={()=> removeTruck(tk.id)}
              >
                Delete
              </button>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // ------------------ 8) ListTab (All) ------------------
  function ListTab(){
    const [msg,setMsg] = React.useState("");
    const [cars,setCars] = React.useState([]);
    const [trucks,setTrucks] = React.useState([]);
    const [trailers,setTrailers] = React.useState([]);

    const loadAll = async()=>{
      setMsg("Loading...");
      try {
        const c = await listCars();
        const t = await listTrucks();
        const r = await listTrailers();
        setCars(c); setTrucks(t); setTrailers(r);
        setMsg(`Loaded cars=${c.length}, trucks=${t.length}, trailers=${r.length}`);
      } catch(err) {
        setMsg("Error: "+err.message);
      }
    };

    React.useEffect(()=>{ loadAll(); },[]);

    return (
      <div className="card">
        <h2>List All (Cars, Trucks, Trailers)</h2>
        {msg && <div>{msg}</div>}
        <button onClick={loadAll}>Reload</button>
        <h3>Cars</h3>
        <ul>
          {cars.map(car=>(
            <li key={car.id}>ID={car.id}, VIN={car.vin}, Make={car.make}, Year={car.year}</li>
          ))}
        </ul>
        <h3>Trucks</h3>
        <ul>
          {trucks.map(tk=>(
            <li key={tk.id}>ID={tk.id}, Nickname={tk.nickname}, Type={tk.truck_type}, Year={tk.year}</li>
          ))}
        </ul>
        <h3>Trailers</h3>
        <ul>
          {trailers.map(tr=>(
            <li key={tr.id}>
              ID={tr.id}, Nickname={tr.nickname}, Year={tr.year}, capacity={tr.capacity_in}
            </li>
          ))}
        </ul>
      </div>
    );
  }

  // ------------------ 9) Main App ------------------
  function App(){
    const [activeTab,setActiveTab] = React.useState("car");
    const [dbStatus,setDbStatus] = React.useState("Checking DB...");

    React.useEffect(()=>{
      checkDB().then(st=> setDbStatus(st));
    },[]);

    return (
      <div>
        <h1>CarLogix Full Debug Interface</h1>
        <p style={{ fontStyle:"italic" }}>{dbStatus}</p>
        <div className="tabs">
          <button onClick={()=>setActiveTab("car")}>Cars</button>
          <button onClick={()=>setActiveTab("truck")}>Trucks (Full Editor)</button>
          <button onClick={()=>setActiveTab("trailer")}>Trailers</button>
          <button onClick={()=>setActiveTab("list")}>List All</button>
        </div>

        {activeTab==="car" && <CarTab/>}
        {activeTab==="truck" && <TruckFullEditor/>}
        {activeTab==="trailer" && <TrailerTab/>}
        {activeTab==="list" && <ListTab/>}
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>