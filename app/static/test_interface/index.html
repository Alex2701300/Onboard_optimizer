<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CarLogix Full Debug Interface</title>

  <!-- Подключаем React, ReactDOM, Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    .tabs button {
      margin-right: 8px;
      padding: 8px 16px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .tabs button:hover {
      background: #f0f0f0;
    }
    .card {
      background: #fff;
      padding: 16px;
      margin-top: 16px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    .success {
      background: #e7ffe7;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      color: #1a7a1a;
    }
    .error {
      background: #ffeaea;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      color: #9d1a1a;
    }
    label {
      display: block;
      font-weight: bold;
      margin: 4px 0 2px;
    }
    input, select, textarea, button {
      margin-bottom: 8px;
      padding: 6px;
    }
    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
    }
    button:hover {
      background: #eee;
    }
    .sub-block {
      border: 1px solid #ccc;
      padding: 8px;
      margin: 8px 0;
      border-radius: 4px;
      background: #fafafa;
    }
    .sub-title {
      font-weight: bold;
      margin-bottom: 4px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .inline-btns button {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">

    // ------------------------------ UTILS ------------------------------
    // Проверка подключения к БД - вызываем /api/cars (GET) 
    // (если вернёт 200 или 404, считаем "ок", иначе ошибка)
    async function checkDB() {
      try {
        const res = await fetch("/api/cars");
        if (!res.ok && res.status !== 404) {
          throw new Error("Status=" + res.status);
        }
        return "MongoDB connected ✔";
      } catch (err) {
        return "DB error: " + err.message;
      }
    }

    // ------------------------------ CARS CRUD ------------------------------
    async function createCar(payload) {
      const res = await fetch("/api/cars", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Create car error");
      }
      return await res.json();
    }
    async function listCars() {
      const res = await fetch("/api/cars");
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "List cars error");
      }
      return await res.json();
    }

    // ------------------------------ TRUCKS CRUD ------------------------------
    async function createTruck(payload) {
      const res = await fetch("/api/trucks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Create truck error");
      }
      return await res.json();
    }
    async function listTrucks() {
      const res = await fetch("/api/trucks");
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "List trucks error");
      }
      return await res.json();
    }
    async function getTruck(truck_id) {
      const res = await fetch("/api/trucks/" + truck_id);
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Get truck error");
      }
      return await res.json();
    }
    async function updateTruck(truck_id, updates) {
      const res = await fetch("/api/trucks/" + truck_id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates)
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Update truck error");
      }
      return await res.json();
    }
    async function deleteTruck(truck_id) {
      const res = await fetch("/api/trucks/" + truck_id, {
        method: "DELETE"
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Delete truck error");
      }
      return true;
    }

    // ------------------------------ TRAILERS CRUD ------------------------------
    async function createTrailer(payload) {
      const res = await fetch("/api/trailers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Create trailer error");
      }
      return await res.json();
    }
    async function listTrailers() {
      const res = await fetch("/api/trailers");
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "List trailers error");
      }
      return await res.json();
    }


    // ------------------------------ CAR TAB ------------------------------
    function CarTab() {
      const [msg, setMsg] = React.useState("");
      const [form, setForm] = React.useState({
        vin: "1G1YZ26E895111766",
        make: "Ford",
        model: "Focus",
        year: "2023",
        length_in: "200",
        width_in: "80",
        height_ft: "5",
        wheelbase_in: "110"
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        setMsg("");
        const payload = {
          vin: form.vin,
          make: form.make,
          model: form.model,
          year: parseInt(form.year, 10),
          length_in: parseFloat(form.length_in),
          width_in: parseFloat(form.width_in),
          height_ft: parseFloat(form.height_ft),
          wheelbase_in: parseFloat(form.wheelbase_in)
        };
        try {
          const data = await createCar(payload);
          setMsg("Car created! ID=" + data.id);
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      return (
        <div className="card">
          <h2>Create Car (all dims in inches/feet)</h2>
          {msg && <div>{msg}</div>}
          <form onSubmit={handleSubmit}>
            <label>VIN</label>
            <input
              value={form.vin}
              onChange={(e) => setForm({ ...form, vin: e.target.value })}
              required
            />
            <label>Make</label>
            <input
              value={form.make}
              onChange={(e) => setForm({ ...form, make: e.target.value })}
              required
            />
            <label>Model</label>
            <input
              value={form.model}
              onChange={(e) => setForm({ ...form, model: e.target.value })}
              required
            />
            <label>Year</label>
            <input
              type="number"
              value={form.year}
              onChange={(e) => setForm({ ...form, year: e.target.value })}
              required
            />
            <label>Length (inches)</label>
            <input
              type="number"
              value={form.length_in}
              onChange={(e) => setForm({ ...form, length_in: e.target.value })}
            />
            <label>Width (inches)</label>
            <input
              type="number"
              value={form.width_in}
              onChange={(e) => setForm({ ...form, width_in: e.target.value })}
            />
            <label>Height (feet)</label>
            <input
              type="number"
              value={form.height_ft}
              onChange={(e) => setForm({ ...form, height_ft: e.target.value })}
            />
            <label>Wheelbase (inches)</label>
            <input
              type="number"
              value={form.wheelbase_in}
              onChange={(e) => setForm({ ...form, wheelbase_in: e.target.value })}
            />
            <button type="submit">Create Car</button>
          </form>
        </div>
      );
    }

    // ------------------------------ TRAILER TAB ------------------------------
    function TrailerTab() {
      const [msg, setMsg] = React.useState("");
      const [form, setForm] = React.useState({
        nickname: "My Trailer",
        year: "2023",
        capacity_in: "500"
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        setMsg("");
        const payload = {
          nickname: form.nickname,
          year: parseInt(form.year, 10),
          capacity_in: parseFloat(form.capacity_in)
        };
        try {
          const data = await createTrailer(payload);
          setMsg("Trailer created! ID=" + data.id);
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      return (
        <div className="card">
          <h2>Create Trailer</h2>
          {msg && <div>{msg}</div>}
          <form onSubmit={handleSubmit}>
            <label>Nickname</label>
            <input
              value={form.nickname}
              onChange={(e) => setForm({ ...form, nickname: e.target.value })}
              required
            />
            <label>Year</label>
            <input
              type="number"
              value={form.year}
              onChange={(e) => setForm({ ...form, year: e.target.value })}
              required
            />
            <label>Capacity (inches?)</label>
            <input
              type="number"
              value={form.capacity_in}
              onChange={(e) => setForm({ ...form, capacity_in: e.target.value })}
            />
            <button type="submit">Create Trailer</button>
          </form>
        </div>
      );
    }

    // ------------------------------ FULL TRUCK EDITOR (Deck/Platform/Edge) ------------------------------
    // 1. Editor for Edge
    function EdgeEditor({ edge, onChangeEdge }) {
      const handle = (field, value) => {
        onChangeEdge({ ...edge, [field]: value });
      };
      return (
        <div className="sub-block" style={{ background: "#fafce7" }}>
          <div className="sub-title">Edge {edge.position || ""}</div>
          <label>Position (A/B)</label>
          <input
            value={edge.position || ""}
            onChange={(e) => handle("position", e.target.value)}
          />

          <label>Type (mobile/static)</label>
          <select
            value={edge.type || "static"}
            onChange={(e) => handle("type", e.target.value)}
          >
            <option value="mobile">mobile</option>
            <option value="static">static</option>
          </select>

          <label>Height (if static, inches)</label>
          <input
            type="number"
            value={edge.height || ""}
            onChange={(e) => handle("height", parseFloat(e.target.value) || 0)}
          />

          <label>Min Height (if mobile)</label>
          <input
            type="number"
            value={edge.min_height || ""}
            onChange={(e) => handle("min_height", parseFloat(e.target.value) || 0)}
          />

          <label>Max Height (if mobile)</label>
          <input
            type="number"
            value={edge.max_height || ""}
            onChange={(e) => handle("max_height", parseFloat(e.target.value) || 0)}
          />

          <label>Is Open Edge?</label>
          <input
            type="checkbox"
            checked={edge.is_open || false}
            onChange={(e) => handle("is_open", e.target.checked)}
          />

          <label>Load Overhang (inches)</label>
          <input
            type="number"
            value={edge.load_overhang || ""}
            onChange={(e) => handle("load_overhang", parseFloat(e.target.value) || 0)}
          />

          <label>Deeping (max 4)</label>
          <input
            type="number"
            value={edge.deeping || ""}
            onChange={(e) => handle("deeping", parseFloat(e.target.value) || 0)}
          />
        </div>
      );
    }

    // 2. Editor for Slide
    function SlideEditor({ slide, onChangeSlide }) {
      const handle = (field, value) => {
        onChangeSlide({ ...slide, [field]: value });
      };
      return (
        <div className="sub-block" style={{ background: "#f0faff" }}>
          <div className="sub-title">Slide</div>
          <label>Type</label>
          <select
            value={slide.type || "none"}
            onChange={(e) => handle("type", e.target.value)}
          >
            <option value="none">none</option>
            <option value="platform_slide">platform_slide</option>
            <option value="a_slide">a_slide</option>
            <option value="b_slide">b_slide</option>
          </select>

          <label>Min Length</label>
          <input
            type="number"
            value={slide.min_length || ""}
            onChange={(e) => handle("min_length", parseFloat(e.target.value) || 0)}
          />

          <label>Max Length</label>
          <input
            type="number"
            value={slide.max_length || ""}
            onChange={(e) => handle("max_length", parseFloat(e.target.value) || 0)}
          />

          <label>Min Distance</label>
          <input
            type="number"
            value={slide.min_distance || ""}
            onChange={(e) => handle("min_distance", parseFloat(e.target.value) || 0)}
          />

          <label>Max Distance</label>
          <input
            type="number"
            value={slide.max_distance || ""}
            onChange={(e) => handle("max_distance", parseFloat(e.target.value) || 0)}
          />
        </div>
      );
    }

    // 3. Editor for Platform
    function PlatformEditor({ platform, onChangePlatform, onRemove }) {
      const handle = (field, val) => {
        onChangePlatform({ ...platform, [field]: val });
      };

      const handleEdgeA = (upd) => handle("edge_a", upd);
      const handleEdgeB = (upd) => handle("edge_b", upd);
      const handleSlide = (upd) => handle("slide", upd);

      return (
        <div className="sub-block" style={{ background: "#fffdf0" }}>
          <div className="sub-title">
            Platform {platform.id || ""}{" "}
            <button type="button" onClick={onRemove} style={{ float: "right" }}>
              Remove
            </button>
          </div>

          <label>Platform ID</label>
          <input
            value={platform.id || ""}
            onChange={(e) => handle("id", e.target.value)}
          />

          <label>Deck Type</label>
          <select
            value={platform.deck_type || "upper_deck"}
            onChange={(e) => handle("deck_type", e.target.value)}
          >
            <option value="upper_deck">upper_deck</option>
            <option value="lower_deck">lower_deck</option>
          </select>

          <label>Position (int)</label>
          <input
            type="number"
            value={platform.position || ""}
            onChange={(e) => handle("position", parseInt(e.target.value) || 0)}
          />

          <label>Default Length (inches)</label>
          <input
            type="number"
            value={platform.default_length || ""}
            onChange={(e) => handle("default_length", parseFloat(e.target.value) || 0)}
          />

          {/* Edges */}
          <h4>Edge A</h4>
          <EdgeEditor edge={platform.edge_a || {}} onChangeEdge={handleEdgeA} />
          <h4>Edge B</h4>
          <EdgeEditor edge={platform.edge_b || {}} onChangeEdge={handleEdgeB} />

          {/* Slide */}
          <h4>Slide (optional)</h4>
          {platform.slide ? (
            <SlideEditor
              slide={platform.slide}
              onChangeSlide={handleSlide}
            />
          ) : (
            <button
              type="button"
              onClick={() =>
                handle("slide", {
                  type: "none",
                  min_length: 0,
                  max_length: 0,
                  min_distance: 0,
                  max_distance: 0
                })
              }
            >
              + Add Slide
            </button>
          )}
        </div>
      );
    }

    // 4. Editor for Joint
    function JointEditor({ joint, onChangeJoint, onRemove }) {
      const handle = (field, val) => {
        onChangeJoint({ ...joint, [field]: val });
      };
      return (
        <div className="sub-block" style={{ background: "#fafafa" }}>
          <div className="sub-title">
            Joint: {joint.type || ""}
            <button
              type="button"
              onClick={onRemove}
              style={{ float: "right" }}
            >
              Remove
            </button>
          </div>
          <label>Type</label>
          <select
            value={joint.type || "static_joint"}
            onChange={(e) => handle("type", e.target.value)}
          >
            <option value="static_joint">static_joint</option>
            <option value="open_free_joint">open_free_joint</option>
            <option value="articulated_sliding_joint">articulated_sliding_joint</option>
            <option value="semi_open_free_joint">semi_open_free_joint</option>
            <option value="semi_fix_joint">semi_fix_joint</option>
            <option value="turning_joint">turning_joint</option>
          </select>

          <label>Platform A ID</label>
          <input
            value={joint.platform_a || ""}
            onChange={(e) => handle("platform_a", e.target.value)}
          />

          <label>Platform B ID</label>
          <input
            value={joint.platform_b || ""}
            onChange={(e) => handle("platform_b", e.target.value)}
          />

          <label>Edge A (A/B)</label>
          <input
            value={joint.edge_a || ""}
            onChange={(e) => handle("edge_a", e.target.value)}
          />

          <label>Edge B (A/B)</label>
          <input
            value={joint.edge_b || ""}
            onChange={(e) => handle("edge_b", e.target.value)}
          />

          <label>Minimum Loading Distance</label>
          <input
            type="number"
            value={joint.minimum_loading_distance || ""}
            onChange={(e) =>
              handle("minimum_loading_distance", parseFloat(e.target.value) || 0)
            }
          />

          <label>Max Overlap</label>
          <input
            type="number"
            value={joint.max_overlap || ""}
            onChange={(e) => handle("max_overlap", parseFloat(e.target.value) || 0)}
          />
        </div>
      );
    }

    // 5. Editor for Deck
    function DeckEditor({ deck, onChangeDeck, onRemoveDeck }) {
      const handle = (field, value) => {
        onChangeDeck({ ...deck, [field]: value });
      };
      // Platforms
      const addPlatform = () => {
        const newPlatform = {
          id: "Plat" + (deck.platforms.length + 1),
          deck_type: deck.type || "upper_deck",
          position: deck.platforms.length + 1,
          default_length: 240,
          edge_a: { position: "A", type: "static", height: 50 },
          edge_b: { position: "B", type: "static", height: 50 },
          slide: null
        };
        onChangeDeck({
          ...deck,
          platforms: [...deck.platforms, newPlatform]
        });
      };
      const removePlatform = (idx) => {
        const newPlats = [...deck.platforms];
        newPlats.splice(idx, 1);
        onChangeDeck({ ...deck, platforms: newPlats });
      };
      const handlePlatformChange = (idx, upd) => {
        const newPlats = [...deck.platforms];
        newPlats[idx] = upd;
        onChangeDeck({ ...deck, platforms: newPlats });
      };

      // Joints
      const addJoint = () => {
        const newJoint = {
          type: "static_joint",
          platform_a: "",
          platform_b: "",
          edge_a: "A",
          edge_b: "B"
        };
        onChangeDeck({
          ...deck,
          joints: [...deck.joints, newJoint]
        });
      };
      const removeJoint = (idx) => {
        const newJs = [...deck.joints];
        newJs.splice(idx, 1);
        onChangeDeck({ ...deck, joints: newJs });
      };
      const handleJointChange = (idx, upd) => {
        const newJs = [...deck.joints];
        newJs[idx] = upd;
        onChangeDeck({ ...deck, joints: newJs });
      };

      return (
        <div className="sub-block" style={{ background: "#fffae7" }}>
          <div className="sub-title">
            Deck: {deck.type || ""}{" "}
            <button type="button" onClick={onRemoveDeck} style={{ float: "right" }}>
              Remove Deck
            </button>
          </div>
          <label>Deck Type</label>
          <select
            value={deck.type || "upper_deck"}
            onChange={(e) => handle("type", e.target.value)}
          >
            <option value="upper_deck">upper_deck</option>
            <option value="lower_deck">lower_deck</option>
          </select>

          <label>Total Length (inches)</label>
          <input
            type="number"
            value={deck.total_length || ""}
            onChange={(e) => handle("total_length", parseFloat(e.target.value) || 0)}
          />

          <h4>Platforms</h4>
          <button type="button" onClick={addPlatform}>+ Add Platform</button>
          {deck.platforms.map((p, i) => (
            <PlatformEditor
              key={i}
              platform={p}
              onChangePlatform={(upd) => handlePlatformChange(i, upd)}
              onRemove={() => removePlatform(i)}
            />
          ))}

          <h4>Joints</h4>
          <button type="button" onClick={addJoint}>+ Add Joint</button>
          {deck.joints.map((j, i) => (
            <JointEditor
              key={i}
              joint={j}
              onChangeJoint={(upd) => handleJointChange(i, upd)}
              onRemove={() => removeJoint(i)}
            />
          ))}
        </div>
      );
    }

    // 6. Editor for VerticalConnection
    function VerticalConnectionEditor({ vc, onChangeVC, onRemove }) {
      const handle = (field, val) => {
        onChangeVC({ ...vc, [field]: val });
      };
      // parse clearance_profile from text?
      const parseProfile = (text) => {
        const out = {};
        text.split(",").forEach((pair) => {
          const [k,v] = pair.split("=").map(x => x.trim());
          if (k) out[k] = parseFloat(v) || 0;
        });
        handle("clearance_profile", out);
      };

      const makeProfileString = () => {
        if (!vc.clearance_profile) return "";
        return Object.entries(vc.clearance_profile)
          .map(([k,v]) => `${k}=${v}`)
          .join(",");
      };

      return (
        <div className="sub-block" style={{ background: "#ffeaea" }}>
          <div className="sub-title">
            Vertical Connection
            <button
              type="button"
              onClick={onRemove}
              style={{ float: "right" }}
            >
              Remove
            </button>
          </div>
          <label>Upper Platform ID</label>
          <input
            value={vc.upper_platform_id || ""}
            onChange={(e) => handle("upper_platform_id", e.target.value)}
          />

          <label>Lower Platform ID</label>
          <input
            value={vc.lower_platform_id || ""}
            onChange={(e) => handle("lower_platform_id", e.target.value)}
          />

          <label>Clearance Profile (like "front=72,middle=68,rear=72")</label>
          <textarea
            rows={2}
            value={makeProfileString()}
            onChange={(e) => parseProfile(e.target.value)}
          />

          <label>Min Clearance (inches)</label>
          <input
            type="number"
            value={vc.min_clearance || ""}
            onChange={(e) => handle("min_clearance", parseFloat(e.target.value) || 0)}
          />
        </div>
      );
    }

    // 7. Big truck form
    function TruckFullEditor() {
      // Editing or Creating
      const [msg, setMsg] = React.useState("");
      const [editingId, setEditingId] = React.useState(null);
      const [form, setForm] = React.useState({
        nickname: "FullSpec Truck",
        model: "Peterbilt 389",
        year: "2023",
        truck_type: "semi",
        coupling_type: "none",
        gvwr: "40000",
        loading_spots: "0",
        deck_count: "1"
      });
      const [decks, setDecks] = React.useState([]);
      const [verticalConns, setVerticalConns] = React.useState([]);

      const handleForm = (field, val) => {
        setForm({ ...form, [field]: val });
      };

      const addDeck = () => {
        const newDeck = {
          type: "upper_deck",
          total_length: 480,
          platforms: [],
          joints: []
        };
        setDecks([...decks, newDeck]);
      };

      const removeDeck = (idx) => {
        const newArr = [...decks];
        newArr.splice(idx, 1);
        setDecks(newArr);
      };
      const handleDeckChange = (idx, updated) => {
        const arr = [...decks];
        arr[idx] = updated;
        setDecks(arr);
      };

      const addVerticalConn = () => {
        const newVC = {
          upper_platform_id: "",
          lower_platform_id: "",
          clearance_profile: {},
          min_clearance: 6
        };
        setVerticalConns([...verticalConns, newVC]);
      };
      const removeVC = (idx) => {
        const arr = [...verticalConns];
        arr.splice(idx, 1);
        setVerticalConns(arr);
      };
      const handleVCChange = (idx, updated) => {
        const arr = [...verticalConns];
        arr[idx] = updated;
        setVerticalConns(arr);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setMsg("");
        // build the final payload
        const payload = {
          nickname: form.nickname,
          model: form.model,
          year: parseInt(form.year, 10),
          truck_type: form.truck_type,
          coupling_type: form.coupling_type,
          gvwr: parseFloat(form.gvwr),
          loading_spots: parseInt(form.loading_spots, 10),
          deck_count: parseInt(form.deck_count, 10)
        };
        if (decks[0]) payload.upper_deck = decks[0];
        if (decks[1]) payload.lower_deck = decks[1];
        if (verticalConns.length > 0) payload.vertical_connections = verticalConns;

        try {
          let result;
          if (!editingId) {
            // create
            result = await createTruck(payload);
            setMsg("Created Truck ID=" + result.id);
          } else {
            // update
            result = await updateTruck(editingId, payload);
            setMsg("Updated Truck ID=" + result.id);
          }
          // reset
          setEditingId(null);
          setForm({
            nickname: "",
            model: "",
            year: "2023",
            truck_type: "semi",
            coupling_type: "none",
            gvwr: "40000",
            loading_spots: "0",
            deck_count: "1"
          });
          setDecks([]);
          setVerticalConns([]);
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      // A function for external load
      const loadTruck = async (id) => {
        setMsg("Loading truck " + id + " for editing...");
        try {
          const doc = await getTruck(id);
          setEditingId(doc.id);
          // doc => truck
          setForm({
            nickname: doc.nickname || "",
            model: doc.model || "",
            year: doc.year ? String(doc.year) : "2023",
            truck_type: doc.truck_type || "semi",
            coupling_type: doc.coupling_type || "none",
            gvwr: doc.gvwr ? String(doc.gvwr) : "40000",
            loading_spots: doc.loading_spots ? String(doc.loading_spots) : "0",
            deck_count: doc.deck_count ? String(doc.deck_count) : "1"
          });
          const arrDecks = [];
          if (doc.upper_deck) arrDecks.push(doc.upper_deck);
          if (doc.lower_deck) arrDecks.push(doc.lower_deck);
          setDecks(arrDecks);
          setVerticalConns(doc.vertical_connections || []);
          setMsg("Editing truck " + doc.id);
        } catch (err) {
          setMsg("Load error: " + err.message);
        }
      };

      // expose loadTruck globally for debugging
      React.useEffect(() => {
        window._fullTruckLoad = loadTruck;
      }, []);

      return (
        <div className="card">
          <h2>{editingId ? "Edit Truck (Full Spec)" : "Create Truck (Full Spec)"}</h2>
          {msg && <div>{msg}</div>}
          <form onSubmit={handleSubmit}>
            <label>Nickname</label>
            <input
              value={form.nickname}
              onChange={(e) => handleForm("nickname", e.target.value)}
              required
            />
            <label>Model</label>
            <input
              value={form.model}
              onChange={(e) => handleForm("model", e.target.value)}
              required
            />
            <label>Year</label>
            <input
              type="number"
              value={form.year}
              onChange={(e) => handleForm("year", e.target.value)}
              required
            />
            <label>Truck Type</label>
            <select
              value={form.truck_type}
              onChange={(e) => handleForm("truck_type", e.target.value)}
            >
              <option value="semi">semi</option>
              <option value="stinger_head">stinger_head</option>
              <option value="stinger_five">stinger_five</option>
              <option value="semi_platform">semi_platform</option>
              <option value="pickup">pickup</option>
              <option value="towtruck">towtruck</option>
            </select>
            <label>Coupling Type</label>
            <select
              value={form.coupling_type}
              onChange={(e) => handleForm("coupling_type", e.target.value)}
            >
              <option value="none">none</option>
              <option value="5th_wheel">5th_wheel</option>
              <option value="gooseneck">gooseneck</option>
              <option value="bumper_pool">bumper_pool</option>
            </select>
            <label>GVWR (lbs)</label>
            <input
              type="number"
              value={form.gvwr}
              onChange={(e) => handleForm("gvwr", e.target.value)}
            />
            <label>Loading Spots</label>
            <input
              type="number"
              value={form.loading_spots}
              onChange={(e) => handleForm("loading_spots", e.target.value)}
            />
            <label>Deck Count</label>
            <input
              type="number"
              value={form.deck_count}
              onChange={(e) => handleForm("deck_count", e.target.value)}
            />

            {/* Decks */}
            <h4>Decks</h4>
            <button type="button" onClick={addDeck}>+ Add Deck</button>
            {decks.map((dk, i) => (
              <DeckEditor
                key={i}
                deck={dk}
                onChangeDeck={(upd) => handleDeckChange(i, upd)}
                onRemoveDeck={() => removeDeck(i)}
              />
            ))}

            {/* Vertical connections */}
            <h4>Vertical Connections</h4>
            <button type="button" onClick={addVerticalConn}>+ Add VerticalConn</button>
            {verticalConns.map((vc, i) => (
              <VerticalConnectionEditor
                key={i}
                vc={vc}
                onChangeVC={(upd) => handleVCChange(i, upd)}
                onRemove={() => removeVC(i)}
              />
            ))}

            <button type="submit" style={{ marginTop: "12px" }}>
              {editingId ? "Update Truck" : "Create Truck"}
            </button>
          </form>
        </div>
      );
    }

    // ------------------------------ TRUCK CHOICE TABS (Simple vs Full) ------------------------------
    // Если нужно, мы можем дать две вкладки: SimpleTruckTab / FullTruckTab
    // Но для краткости используем FullEditor как "TruckTab".

    // ------------------------------ LIST TAB ------------------------------
    // Показываем все три типа (cars, trucks, trailers)
    function ListTab() {
      const [msg, setMsg] = React.useState("");
      const [cars, setCars] = React.useState([]);
      const [trucks, setTrucks] = React.useState([]);
      const [trailers, setTrailers] = React.useState([]);

      const loadAll = async () => {
        setMsg("Loading...");
        try {
          const c = await listCars();
          const t = await listTrucks();
          const r = await listTrailers();
          setCars(c);
          setTrucks(t);
          setTrailers(r);
          setMsg(`Loaded cars=${c.length}, trucks=${t.length}, trailers=${r.length}`);
        } catch (err) {
          setMsg("Error: " + err.message);
        }
      };

      React.useEffect(() => {
        loadAll();
      }, []);

      return (
        <div className="card">
          <h2>List All (Cars, Trucks, Trailers)</h2>
          {msg && <div>{msg}</div>}
          <button onClick={loadAll}>Reload</button>

          <h3>Cars</h3>
          <ul>
            {cars.map((car) => (
              <li key={car.id}>
                ID={car.id}, VIN={car.vin}, Make={car.make}, Year={car.year}
              </li>
            ))}
          </ul>

          <h3>Trucks</h3>
          <ul>
            {trucks.map((tk) => (
              <li key={tk.id}>
                ID={tk.id}, Nickname={tk.nickname}, Type={tk.truck_type}, Year={tk.year}
              </li>
            ))}
          </ul>

          <h3>Trailers</h3>
          <ul>
            {trailers.map((tr) => (
              <li key={tr.id}>
                ID={tr.id}, Nickname={tr.nickname}, Year={tr.year}, capacity={tr.capacity_in}
              </li>
            ))}
          </ul>
        </div>
      );
    }

    // ------------------------------ MAIN APP ------------------------------
    function App() {
      const [activeTab, setActiveTab] = React.useState("car");
      const [dbStatus, setDbStatus] = React.useState("Checking DB...");

      React.useEffect(() => {
        checkDB().then(st => setDbStatus(st));
      }, []);

      return (
        <div>
          <h1>CarLogix Full Debug Interface</h1>
          <p style={{ fontStyle: "italic" }}>{dbStatus}</p>

          <div className="tabs">
            <button onClick={() => setActiveTab("car")}>Cars</button>
            <button onClick={() => setActiveTab("truck")}>Trucks (Full Editor)</button>
            <button onClick={() => setActiveTab("trailer")}>Trailers</button>
            <button onClick={() => setActiveTab("list")}>List All</button>
          </div>

          {activeTab === "car" && <CarTab />}
          {activeTab === "truck" && <TruckFullEditor />}
          {activeTab === "trailer" && <TrailerTab />}
          {activeTab === "list" && <ListTab />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>